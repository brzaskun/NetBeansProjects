<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:p="http://primefaces.org/ui"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:pe="http://primefaces.org/ui/extensions"
    >

    <p:dialog id="zapisy" header="Zapisy na kontach" widgetVar="zapisynakoncie"  dynamic="true"
              resizable="false" onShow="ustawdialog('zapisy','menuraporty',1600,780);$(document.getElementById('formwpiskonta:wyborkonta_input')).select();" onHide="resetujdialog('zapisy');"  closeOnEscape="true" 
              >
        <p:layout fullPage="false" style="width: 1450px; height: 720px;">  
            <p:layoutUnit position="north" >
                <p:panelGrid columns="2" columnClasses="kontaGrid1, kontaGrid2">
                    <h:form id="formwpiskonta">
                        <h:outputText value="wybierz konto: "/>
                        <p:autoComplete id="wyborkonta" value="#{kontoZapisFKView.wybranekonto}" completeMethod="#{kontoView.complete}"
                                        var="p" itemLabel="#{p.pelnynumer} #{p.nazwapelna}" itemValue="#{p}" cache="true" forceSelection="true"
                                        minQueryLength="1" maxResults="15" maxlength="10" converter="KontoConv" 
                                        converterMessage="Nieudana konwersja Klient"
                                        styleClass="kontoinput, autoCompleteBig" 
                                        >
                            <p:ajax event="query" global="false"/>
                            <p:ajax event="itemSelect" update=":form:dataList, :tabelazzapisami:tabela, :tabelazsumami:sumy, :formwpiskonta:nazwawybranegokonta" 
                                    oncomplete="zaznacznoda('form:dataList_data','form:dataList','formwpiskonta:wyborkonta_input');" global="false"/>
                        </p:autoComplete>
                        <h:outputText value="  wybrane konto:"/>
                        <h:outputText id="nazwawybranegokonta" value=" #{kontoZapisFKView.wybranekonto.nazwapelna}" style="font-weight: 900;" />
                    </h:form>
                    <h:form id="walutazapisynakoncie">
                        <h:outputText value="waluta dokumentu: " style="text-align: right;"/>
                        <h:selectOneMenu id="wybranawaluta" value="#{kontoZapisFKView.wybranaWalutaDlaKont}" style="width: 100px;">
                            <p:ajax event="change" listener="#{kontoZapisFKView.pobierzZapisyZmianaWaluty}" update=":tabelazzapisami:tabela, :tabelazsumami:sumy" />
                            <f:selectItem itemValue="wszystkie" itemLabel="wszystkie"/>
                            <f:selectItems value="#{walutyViewFK.symboleWalut}"/>
                        </h:selectOneMenu>
                    </h:form>
                </p:panelGrid>
                <h:outputText value="#{kontoZapisFKView.zapisydopodswietlenia}" id="zapisydopodswietlenia"  style="display: none;"/>
            </p:layoutUnit>  
            <!--            lewa strona z drzewem kont-->
            <p:layoutUnit id="westtree" position="west" size="350" >
                <p:panelGrid columns="2" >
                    <p:commandButton id="rozwinwsz" value="rozwiń wszystkie" actionListener="#{planKontView.rozwinwszystkie(planKontView.root)}" update=":form:dataList" style="float: left;" />
                    <p:commandButton id="zwinwsz" value="zwiń wszystkie" actionListener="#{planKontView.zwinwszystkie(planKontView.root)}" update=":form:dataList" style="float: left;" />
                </p:panelGrid>
                <h:form id="form">
                    <p:hotkey bind="down" global="false"  onstart="przejdzwiersz();"/>
                    <p:hotkey bind="up" global="false"  onstart="wrocwiersz();"/>
                    <script>
                        /* <![CDATA[ */
                        //dzieki tej genialnej funkcji wie na ktorym rowku kliknelismy i od tego zacyzn alazenie
                        $(document).on("click", '.grid tr', function(e) {
                            try {
                                zachowajobiekt(this, e);
                            } catch (ex) {
                                alert('error dialog zapisynakoncie' + ex.toString());
                            }
                        });
                        $(document).on("click", '.grid1 tr', function(e) {
                            var lolo = $("#tabelazzapisami\\:tabela_data").children("tr");
                            var pierwszy = $(lolo[0]).find(".lpwiersza").text();
                            try {
                                e.stopPropagation(); // will prevent double click events from link being clicked within row
                                var unitNo = $.trim($(this).closest("tr").find(".lpwiersza").text()); // trim to remove end space, closest gets closest parent of selected type
                                var numerwiersza = unitNo - pierwszy;
                                zachowajnumerwiersza("zmiennazapisy", numerwiersza);
                            } catch (e) {
                                alert('error  dialog zapisynakoncie w.69' + ex.toString());
                            }
                        });
                        /* ]]> */
                    </script>
                    <p:outputPanel id="kontenertabeli" deferred="true">
                        <p:treeTable id="dataList" value="#{planKontView.root}" var="loop1" selectionMode="single" 
                                     selection="#{kontoZapisFKView.wybranekontoNode}" 
                                     styleClass="grid" style="width: 100%; height: 550px; overflow-y: scroll;" >
                            <p:ajax event="select" update=":tabelazzapisami:tabela, :tabelazsumami:sumy, :formwpiskonta:nazwawybranegokonta" 
                                    listener="#{kontoZapisFKView.pobierzZapisyNaKoncieNode}" global="false"/>
                            <p:ajax event="unselect" update=":tabelazzapisami:tabela, :tabelazsumami:sumy, :formwpiskonta:nazwawybranegokonta" 
                                    listener="#{kontoZapisFKView.pobierzZapisyNaKoncieNodeUnselect}" global="false"/>
                            <p:column headerText="nr konta" style="width: 100px; height: 30px;" styleClass="#{loop1.level eq 2 ? 'druga' : null}" >
                                <h:outputText value="#{loop1.pelnynumer}"/> 
                            </p:column>
                            <p:column headerText="nazwa pełna" >
                                <h:outputText value="#{loop1.nazwaskrocona}"/> 
                            </p:column>
                        </p:treeTable>
                    </p:outputPanel>
                </h:form>
            </p:layoutUnit>  

            <p:layoutUnit position="center" style="min-width: 1200px;">
                <h:form id="tabelazzapisami">
                    <p:dataTable id="tabela" value="#{kontoZapisFKView.kontozapisy}" var="loop" rowKey="#{loop.wiersz.idwiersza}" style="width: 1180px;"
                                 selection="#{kontoZapisFKView.wybranekontadosumowania}" sortBy="#{loop.wiersz.idwiersza}" emptyMessage="Nie ma zapisów na koncie"
                                 rowIndexVar="rowindex" styleClass="grid1"
                                 >
                        <p:ajax event="rowSelectCheckbox" update=":tabelazsumami:sumy" listener="#{kontoZapisFKView.sumazapisowtotal}"/>
                        <p:ajax event="rowUnselectCheckbox" update=":tabelazsumami:sumy" listener="#{kontoZapisFKView.sumazapisowtotal}"/>
                        <p:ajax event="toggleSelect" update=":tabelazsumami:sumy" listener="#{kontoZapisFKView.sumazapisowtotal}"/>
                        <p:ajax event="rowSelect" update=":tabelazzapisami:tabela, :tabelazsumami:sumy" listener="#{kontoZapisFKView.odszukajsparowanerozrachunki}"/>-->
                        <p:column selectionMode="multiple" width="30" style="text-align: center;"></p:column>
                        <p:column headerText="id" width="30" sortBy="#{loop.id}" >
                            <h:outputText value="#{loop.id}"/>
                        </p:column>
                        <p:column headerText="lp" width="20" sortBy="#{rowindex}" style="text-align: center;">
                            <h:outputText styleClass="lpwiersza"  value="#{rowindex+1}"/>
                        </p:column>
                        <p:column headerText="data" width="40" style="text-align: center;" sortBy="#{loop.wiersz.dataksiegowania}">
                            <h:outputText value="#{loop.wiersz.dataksiegowania.substring(5,10)}"/>
                        </p:column>
                        <p:column headerText="dok." width="60" >
                            <h:outputText value="#{loop.wiersz.dokfk.dokfkPK.seriadokfk}/#{loop.wiersz.dokfk.dokfkPK.nrkolejnywserii}"/>
                        </p:column>
                        <p:column headerText="wiersz" width="30" >
                            <h:outputText value="#{loop.wiersz.idporzadkowy}"/>
                        </p:column>
                        <p:column headerText="opis" width="100" sortBy="#{loop.wiersz.opisWiersza}">
                            <h:outputText value="#{loop.wiersz.opisWiersza}"/>
                        </p:column>
                        <p:column headerText="kurs" width="40" sortBy="#{loop.wiersz.tabelanbp.kurssredni}" rendered="#{kontoZapisFKView.wybranaWalutaDlaKont != 'PLN'}">
                            <h:outputText value="#{loop.wiersz.tabelanbp.kurssredni}" rendered="#{loop.wiersz.tabelanbp.kurssredni > 0.0}"/>
                        </p:column>
                        <p:column headerText="tab" width="40" sortBy="#{loop.wiersz.tabelanbp.nrtabeli.substring(0,3)}"  rendered="#{kontoZapisFKView.wybranaWalutaDlaKont != 'PLN'}">
                            <h:outputText value="#{loop.wiersz.tabelanbp.nrtabeli.substring(0,3)}" rendered="#{loop.wiersz.tabelanbp.nrtabeli.substring(0,3) ne '000'}"/>
                        </p:column>
                        <p:column headerText="Wn" width="60" sortBy="#{loop.kwota}">
                            <h:outputText id="kwotawnwiersz" value="#{loop.wnma eq 'Wn' ? loop.kwota : null}" style="float: right;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Wn w PLN" width="60" sortBy="#{loop.kwotaPLN}" rendered="#{kontoZapisFKView.wybranaWalutaDlaKont ne 'PLN'}">
                            <h:outputText id="kwotawnwierszPLN" value="#{loop.wnma eq 'Wn' ? loop.kwotaPLN : null}" style="float: right;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Ma" width="60" sortBy="#{loop.kwota}">
                            <h:outputText id="kwotamawiersz" value="#{loop.wnma eq 'Ma' ? loop.kwota : null}" style="float: right;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Ma w PLN" width="60" sortBy="#{loop.kwotaPLN}"  rendered="#{kontoZapisFKView.wybranaWalutaDlaKont ne 'PLN'}">
                            <h:outputText id="kwotamawierszPLN" value="#{loop.wnma eq 'Ma' ? loop.kwotaPLN : null}" style="float: right;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Wal." width="30" sortBy="#{loop.wiersz.tabelanbp.waluta.symbolwaluty}" rendered="#{kontoZapisFKView.wybranaWalutaDlaKont ne 'PLN'}">
                            <h:outputText id="waluta" value="#{loop.wiersz.tabelanbp.waluta.symbolwaluty}"/>
                        </p:column>
                        <p:column headerText="Konto przeciw." width="60" sortBy="#{loop.wnma eq 'Wn' ? loop.wiersz.stronaMa.konto.pelnynumer : loop.wiersz.stronaWn.konto.pelnynumer}">
                            <h:outputText id="kontonr" value="#{loop.wnma eq 'Wn' ? loop.wiersz.stronaMa.konto.pelnynumer : loop.wiersz.stronaWn.konto.pelnynumer}"/>
                        </p:column>
                        <!--                        <p:column headerText="Konto przeciwstawne" width="90" sortBy="9{loop.loop.kontoprzeciwstawne}">
                                                    <h:outputText value="9{kontoprzeciwstawne eq '000' ? 'zapis z BO' : loop.kontoprzeciwstawne}"/>
                                                </p:column>-->
                    </p:dataTable>
                </h:form>  
            </p:layoutUnit>  
            <p:layoutUnit position="south" style="height: 70px;">
                <h:form id="tabelazsumami">
                    <p:dataTable id="sumy" value="#{kontoZapisFKView.listasum}" var="loop"
                                 style="float: right; margin-left: 80px; width: 1050px; height: 60px;" emptyMessage="Nie wybrano konta">
                        <p:column headerText="suma Wn">
                            <h:outputText value="#{loop.sumaWn}" style="float: right; font-weight: 700;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="suma Ma">
                            <h:outputText value="#{loop.sumaMa}" style="float: right; font-weight: 700;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="saldo Wn">
                            <h:outputText value="#{loop.saldoWn}" style="float: right; font-weight: 900; color: green;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="saldo Ma">
                            <h:outputText value="#{loop.saldoMa}" style="float: right; font-weight: 900; color: green;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="suma Wn PLN">
                            <h:outputText value="#{loop.sumaWnPLN}" style="float: right; font-weight: 700;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="suma Ma PLN">
                            <h:outputText value="#{loop.sumaMaPLN}" style="float: right; font-weight: 700;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="saldo Wn PLN">
                            <h:outputText value="#{loop.saldoWnPLN}" style="float: right; font-weight: 900; color: green;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="saldo Ma PLN">
                            <h:outputText value="#{loop.saldoMaPLN}" style="float: right; font-weight: 900; color: green;">
                                <f:convertNumber minFractionDigits="2" locale="PL"/>
                            </h:outputText>
                        </p:column>
                    </p:dataTable>
                </h:form>
            </p:layoutUnit>  
        </p:layout>  
    </p:dialog>
</ui:composition>

